title: 恢复了一个Ghost误操作的硬盘 - 感谢VMWare
id: 25
categories:
  - 技术
date: 2006-10-09 21:31:00
tags:
  - 硬盘
  - 修理
  - VMWare
  - DiskGen
---

**声明：本文非教程，模仿本文造成的一切后果与作者无关！**

下午一个同事MM说昨天晚上在家里用Ghost恢复系统，结果发现原本三个分区的80G硬盘只剩下一个接近80G的分区了，问我有没有恢复的办法。经过简单的思考，推测是由于她错误的选择了Ghost的Disk From Image功能（因为她只备份了C盘，所以其实应当使用Partition From Image来恢复）。所幸她的资料都保存在D盘和E盘，因此推测只要能恢复分区表的后面部分，资料应当可以找回。

第一次做这种事情，自然应当尽量谨慎。为了能在恢复过程中有后悔药吃，决定将故障硬盘全盘拷贝一份出来，然后在拷贝上做恢复工作。这样即使能力不足或者操作失当，也不会造成任何不良后果。

故障硬盘是Seagate 80G的，但是手头并没有空闲的80G以上硬盘来做备份。怎么办呢？思考了几秒种之后，决定使用虚拟机软件 - VMWare。于是把故障硬盘挂到我的机器上，启动进入Windows，通过磁盘管理器发现故障硬盘只有一个70多G的FAT32格式主分区。

接下来需要考虑用什么软件做磁盘拷贝。Ghost是不行的，因为它的原理是做文件拷贝，而为了做出一个和故障硬盘精确一致的拷贝，显然需要一个扇区拷贝工具，于是dd就成了当然之选。

dd传统上是linux下的软件，正好我的机器上有个RH9的虚拟机。于是打开VMWare，给Linux虚拟机添加两个IDE硬盘：一个选择物理磁盘，即那个故障硬盘（下称磁盘A）；另外一个则创建新的80G虚拟磁盘（下称磁盘B）。我的机器上也只有一个80G硬盘，显然空间不够用，幸好内网上还有个3TB的文件服务器，于是把这个80G的虚拟硬盘建在了这个文件服务器上。

启动虚拟机，VMWare警告说有个虚拟磁盘文件在远程，会严重影响性能。不管它，点OK继续。进入Linux后，硬盘A和B的设备名应当分别为`/dev/hda`，`/dev/hdb`（虚拟机原本的唯一硬盘是SCSI的，`/dev/sda`）。为了验证一下，我尝试把硬盘A mount起来。输入命令：`mount -t vfat -o ro /dev/hda1 /mnt `，结果mount报错，说什么不是合法的块设备。这可真是奇怪了，可怜我对Linux的设备管理不是很熟，这下就无法确认`/dev/hda`是不是那块硬盘了。无奈，决定使用Windows。

正好我还有个Windows 2000 Advanced Server的虚拟机。于是把A和B添加到Windows虚拟机中，启动。下载了dd的windows移植版本，先输入`dd --list`找到源磁盘和目标磁盘的设备名，然后输入拷贝命令：

```
dd.exe bs=256k if=\\?\Device\HarddiskVolume3 of=\\?\Device\HarddiskVolume4 --progress
```

可怜我的100M网卡+虚拟机，足足花了有3个多小时才复制完成。然后关闭windows虚拟机，删掉多余的硬盘，只剩下刚才拷贝好的虚拟硬盘B，然后用软盘镜像启动虚拟机到DOS下。在DOS下启动一个叫diskgen（曾用名DiskMan）的国产软件，选择“工具”菜单下的“重建分区表”命令，然后在弹出的菜单中选择“手工模式”。

同事MM告知硬盘应当有三个分区，分别大约是10G，34G,30G。根据这个信息，就可以很容易的判断DiskGen找出来的分区是否应当跳过还是保留了。当DiskGen扫描到12%左右的时候，DiskGen报告发现一个扩展分区，大约64G。不错，就是它了！选择“保留”，进度一下子到了93%（为什么不是100%呢？因为这个拷贝版硬盘是80G，而那个出问题的物理硬盘是80,000,000,000字节~=74.5G）。完成以后F8保存分区表，ESC退出。

由于懒得再起虚拟机，于是用VMWare免费提供的虚拟磁盘挂载工具vmware-mount.exe把刚才修复的虚拟硬盘加载起来：很好，后面的两个分区内容完整无缺！

用虚拟机验证了DiskGen能够恢复该硬盘后，剩下的事情就很好办了：把我的真实主机启动到DOS下，启动DiskGen，开始恢复那块真实的故障硬盘，几分钟后，恢复完毕。

事情原本就应当结束了，不过同事MM害怕回家Ghost又会操作失误，于是我只好帮人帮到底了，于是把第一个分区创建好（DiskGen恢复后，第一个分区的位置成了为使用空间），再用Ghost把系统备份从第二个分区恢复了过去，最后把这个分区设置成活动状态。大功告成了！

最后再唠叨几句吧。其实最后的这个过程还发生了个插曲，有耐心看到这里的读者也许都快没耐心了吧？哈哈。由于Ghost只能把镜像恢复到一个已经存在的分区中，因此必须先把第一个分区创建出来。不幸的事，我是用U盘启动到DOS的，而这个U盘是USB-HDD模式。也就是说，启动以后，DOS认为这个U盘是个硬盘。在这种情况下，我手头的Partition Magic 8.0 DOS版似乎对付不了这个情况，一直停止在启动界面进不去。-_-! 无奈，只好启动到windows，用磁盘管理器创建了这个分区。

那么，怎么Ghost呢？我并没有Windows版的Ghost，而且即使有，似乎也还是得重启一遍？（不确定，有哪位读者知道？）麻烦。于是，我再次想到了用VMWare。在虚拟机中Ghost完成后，关掉虚拟机，在设备管理器中停掉这块硬盘后，先拔电源，再拔数据线（**危险！切勿模仿！**），搞定！